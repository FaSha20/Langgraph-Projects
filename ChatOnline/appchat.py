import streamlit as st
from LeadScoring import leadScoring, get_gemini_api_response
from dotenv import load_dotenv

load_dotenv()

st.set_page_config(page_title="Lead Scoring Chat", layout="wide")

st.title("๐ฌ Persian Lead Scoring Chatbot")
st.markdown("ุดุจูโุณุงุฒ ฺฏูุชโูฺฏู ูุดุชุฑ ู ูุฑูุดูุฏู. ุงุจุชุฏุง ูุฑูุดูุฏู ูพุงู ูโุฏูุฏุ ุณูพุณ ุดูุง ูพุงุณุฎ ุฏูุฏ. ุฏุฑ ูพุงุงูุ ุฑู ยซุงูุชุงุฒุฏูยป ุจุฒูุฏ.")

# Define static content
FAQ = """ุณูุงู: ฺฉุณุจโูฺฉุงุฑุชูู ฺู ู ุฏุฑ ฺู ุญูุฒูโุง ูุนุงูุช ูโฺฉูุฏุ
ุฏุฑ ฺฉุณุจโูฺฉุงุฑูุง ฺฉู ุชฺฉุฑุงุฑ ุจู ุฎุฑุฏ ูุนูุงุฏุงุฑู ู ุฎุฑุฏูุง ุฏุฑ ุจุงุฒูโูุง ุฒุฑ ุญุฏุงฺฉุซุฑ ถ ูุงู ุชฺฉุฑุงุฑ ูุดูุ ูฺุฑูุง ูุซู ฺฉุดโุจฺฉ ุจุดุชุฑู ุงุซุฑ ุฑู ุฏุงุฑู. ุงฺฏุฑ ุชฺฉุฑุงุฑ ุจู ุฎุฑุฏ ุฏุฑ ุจุงุฒู ุจุฒุฑฺฏโุชุฑู ุจุงุฏ ุฑู ูฺุฑูุง ูุซู ฺฉููพูโูุง ูพุงูฺฉ ู ูุธุฑุณูุฌ ู ฺฏุฑููโุจูุฏ ูโฆ ูู ูุงููุฑ ุจุฏู.
ุณูุงู: ฺฉุณุจโูฺฉุงุฑุชูู ุขููุงูู ุง ุญุถูุฑุ ุงฺฏุฑ ุขููุงูู ุขุง ุณุงุช ูุฑุฏูพุฑุณ ุง ูพุฌ ุงูุณุชุงฺฏุฑุงู ุฏุงุฑุฏุ
ุจุฑุง ฺฉุณุจโูฺฉุงุฑูุง ุขููุงู ูโุชููู ุณุงุช ูุฑุฏูพุฑุณ ุง ูพุฌ ุงูุณุชุงฺฏุฑุงู ุฑู ุจู ุฏูุจุงุฑู ูุชุตู ฺฉูู ุชุง ุจู ุตูุฑุช ุฎูุฏฺฉุงุฑ ูุฑุขูุฏโูุง ุงูุฌุงู ุจุดู.
ุณูุงู: ุชุง ุงูุงู ุดูุงุฑู ูุดุชุฑุงูุชูู ุฑู ุฌูุนโุขูุฑ ฺฉุฑุฏุฏุ
ุงฺฏุฑ ูุดุชุฑ ูุณุช ุงุฒ ุดูุงุฑู ูุดุชุฑุงูุด ุฏุงุฑู ูโุชููู ฺฉููพู ูพุงูฺฉ ุฑู ูพุดููุงุฏ ุจุฏู. ุจุง ุงุทููุงู ุฎุงุทุฑ ุงุฒ ุงูฺฉู ูุทุนุง ฺฉููพู ูพุงูฺฉ ูุฑูุด ุฎูุจ ุจู ููุฑุงู ุฏุงุฑู.
ุณูุงู: ฺุทูุฑ ุจู ุงูุฒุงุด ูุฑูุดู ฺฉูฺฉ ูโฺฉูุฏุ
ุฏุฑ ูพุงุณุฎ ุจู ุงู ุณูุงู ุจู ุตูุฑุช ูุฑุญูู ุจู ูุฑุญููุ ูุฏ ูฺฏูุชุ ฺฉุดโุจฺฉ ู ฺฉููพูโูุง ูพุงูฺฉ ุฑู ุจู ููุฑุงู ุงุซุฑ ุงุญุชูุงูุด ุดุฑุญ ุจุฏู.
 ุณูุงู: ููุช ูุญุตููุชูู ุจู ฺู ุตูุฑุชูุ
ุฏุฑ ูพุงุณุฎ ุจู ุงู ุณูุงู: ุจุฑุง ุงุณุชูุงุฏู ุงุฒ ูุฑูโุงูุฒุงุฑ ุจุงุดฺฏุงู ูุดุชุฑุงู ูุงุฒ ุจู ุฎุฑุฏ ุงุดุชุฑุงฺฉ ูุณุช. ุดูุง ูโุชููุฏ ุจู ููุฏุงุฑ ูุงุฒุชูู ูพูู ุฑู ุดุงุฑฺ ฺฉูุฏ. ุจู ุงุฒุง ูุฑ ุฑููุฏ ุฎูุฏฺฉุงุฑ ฒตฐฐ ุชููุงู ุงุฒ ุดุงุฑฺ ูพููุชูู ฺฉุณุฑ ูุดู. ุจุฑุง ฺฉููพูโูุง ูพุงูฺฉ ูู ููุช ูุฑ ุตูุญู ูพุงูฺฉ (ูุนุงุฏู ถท ฺฉุงุฑุงฺฉุชุฑ) ฑธน ุชููุงู ูุณุช ฺฉู ุงุฒ ุดุงุฑฺุชูู ฺฉู ูุดู. ุจุฑุง ุดุฑูุน ูโุชููุฏ ุจุง ตฐฐ ูุฒุงุฑ ุชููู ุดุงุฑฺ ุงููู ฺฉุงุฑุชูู ุฑู ุขุบุงุฒ ฺฉูุฏ ู ุณุณุชู ุฑู ุชุณุช ฺฉูุฏ. ฺฉุงุชุงููฺฏ ููุช ุฑู ุงุฑุณุงู ฺฉู.
ฺุงูุด: ุงฺฏุฑ ุฏุฏู ูุดุชุฑ ฺุงูุด ููุช ุฏุงุฑู.
ุดูุง ูโุชููุฏ ูฺ ูุฒููโุง ูพุฑุฏุงุฎุช ูฺฉูุฏ ู ุงุฒ ุฏูุจุงุฑู ุงุณุชูุงุฏู ฺฉูุฏ. ูุง ูฺ ูุฒููโุง ุจุงุจุช ุฑููุฏูุง ู ูพุงูฺฉโูุง ุฏุฑุงูุช ููโฺฉูู ูู ุฏุฑ ูพุงุงู ูุฑ ูุงู ต ุฏุฑุตุฏ ุงุฒ ูุฑูุด ุงุฌุงุฏ ุดุฏู ุชูุณุท ุฏูุจุงุฑู ุฑู ุจุงุฏ ุจู ุนููุงู ฺฉูุณูู ุงุฒ ุญุณุงุจ ุดูุง ฺฉุณุฑ ูุดู. ูพุดููุงุฏ ูุง ุงูู ฺฉู ุจุง ูุฏู ุงูุชุตุงุฏ ูพุด ุจุฑุฏ ฺูู ุงุฒ ุงู ูุฏู ุจู ุตุฑููโุชุฑ ูุณุช.
ุณูุงู: ุงูุฒููู ูุฑุฏูพุฑุณ ุจุงุดฺฏุงู ูุดุชุฑุงู ุณุงุช ุฑู ฺฉูุฏ ููโฺฉููุ
ุฎุฑ. ุงูุฒููู ูุฑุฏูพุฑุณ ุฏูุจุงุฑู ููุท ุฏุชุง ูุจูุบ ุณูุงุฑุด ู ูุงู ู ุดูุงุฑู ูุดุชุฑ ุฑู ุงุฒ ุทุฑู API ุจุฑูโุฏุงุฑู ู ุชูุงู ูุญุงุณุจุงุช ุฑู ุฏุชุงุจุณโูุง ุฏูุจุงุฑู ุงูุฌุงู ูุดู ู ุญุช ูพุงูฺฉโูุง ูู ุงุฒ ุทุฑู ุฏูุจุงุฑู ุงุฑุณุงู ูุดู ู ุงุตูุง ุณุงุช ุฑู ฺฉูุฏ ููโฺฉูู.
ุณูุงู: ูโุชููู ูุดุชุฑุงู ูุจู ุฑู ุจุง ุจุงุดฺฏุงู ุณูฺฉ ฺฉููุ
ุจูู. ุดูุง ูโุชููุฏ ูุณุช ูุดุชุฑุงู ูุจู ุฑู ุฏุฑ ูุฑุฏูพุฑุณ ุณูฺฉ ฺฉูุฏ ู ูุดฺฉู ูุฏุงุฑู.
ุณูุงู: ุจุฑุง ูุตุจ ุจู ุฑุงูููุง ูุงุฒ ุฏุงุฑู.
ุงุฑุณุงู ูุฏู ุขููุฒุด ูุตุจ ุงูุฒููู.
ุณูุงู: ุงูุฒููู ูุฑุฏูพุฑุณ ุฏูุจุงุฑูุ ุจุง ูุงูุจ ุณุงุช ูู ุชุฏุงุฎู ูุฏุงุฑูุ
ุฎุฑ. ุงูุฒููู ุฏูุจุงุฑู ุจุง ุงฺฉุซุฑ ูุงูุจโูุง ุชุณุช ุดุฏู ู ูฺ ุชุฏุงุฎู ุชุงฺฉููู ุจุง ูุงูุจโูุง ูุฑุฏูพุฑุณ ูุดุงูุฏู ูุดุฏู ุงุณุช.
 ุณูุงู: ูโุชููู ุจุฏููู ฺู ุณุงุชุง ุงุฒ ุงูุฒููู ุฏูุจุงุฑู ุงุณุชูุงุฏู ฺฉุฑุฏู ุง ูโฺฉููุ
ุจูู ุฏุฑ ุงุฏุงูู ูุณุช ุงุฒ ุจุฎุด ุงุฒ ุณุงุชโูุง ฺฉู ุงุฒ ุฏูุจุงุฑู ุงุณุชูุงุฏู ูโฺฉูู ุจุฑุงุชูู ุงุฑุณุงู ูโฺฉูู.
ุฎุดฺฉุจุงุฑ ูุฌูุงู (https://najvanshop.ir/)
ุฎุดฺฉุจุงุฑ ุงุนุชูุงุฏ(https://www.etemadnuts.ir/)
ุฑูุณุชุงฺ -ุงุฑฺฏุงูฺฉ ู ุฎุดฺฉุจุงุฑ (https://roostaj.com/)
ููุฏุง ฺฉุงูุง-ุดฺฉูุงุช (https://vandakala.ir/)
ููุฑุดุงูพ (https://mehrbeautyshop.com/)
ูุฑูุดฺฏุงู ุฎูุดฺฏูโุดู
(https://khoshgelshoo.com/)
ูุฑูุดฺฏุงู ูุช ุขู (https://netoffshop.ir/)
ุฏุงุงู ฺฉุงูุง (https://daiankala.com/)
ุงฺฏู ูุณุท ฺฉุงุฑ ุจู ูุดฺฉู ุจุฎูุฑูุ ฺุทูุฑ ุจุง ุชู ูพุดุชุจุงู ุงุฑุชุจุงุท ุจฺฏุฑูุ
ุฏูุจุงุฑู ูพุดุชุจุงู ฺฉุงููุ ุณุฑุน ู ฺูุฏฺฉุงูุงูู ุฏุงุฑู:
๐ ุชูุงุณ ุชููู: ฐฒฑ-นฑฐทฐทตด ุฏุงุฎู ฑทณ
๐ฌ ูพุงู ุฏุฑ ฺุช ุขููุงู ุฏุฑ ุณุงุช ุฏูุจุงุฑู
๐ฌ ูุงุชุณโุงูพ: ุดูุงุฑู ูุณุชูู ูพุดุชุจุงู ุจุฑุง ุงุฑุชุจุงุท ููุฑ +989912152844
๐ฌ ุชูฺฏุฑุงู ูพุดุชุจุงู ุจู ุขโุฏ: https://t.me/dobare2024
โฑ๏ธ ุฏุฑ ุฑูุฒูุง ฺฉุงุฑุ ุฒูุงู ูพุงุณุฎฺฏู ูุนูููุงู ฺฉูุชุฑ ุงุฒ ฒ ุณุงุนุช ู ุฏุฑ ุฑูุฒูุง ุชุนุทู ุญุฏุงฺฉุซุฑ ฑฒ ุณุงุนุช ูุณุช.
"""
system_prompt = f"You are a helpful marketing assistant. this is frequently asked questions that normally you have been asked about:{FAQ}. Answer briefly and concisely without extra explanations."

starting_message = """ุณูุงู
ููุช ุจุฎุฑ.
ุนุงุทูู ุดุฑู ูุณุชู.
ุดูุง ุณุงุช ูุฑุฏูพุฑุณ ุฏุงุฑูุ
ูุง ฺฉ ุงูุฒููู ุจุฑุง ุงูุฒุงุด ูุฑุฎ ุชุจุฏู ุจุงุฒุฏุฏฺฉููุฏูโูุง ุจู ุฎุฑุฏุงุฑ ู ููฺูู ุงูุฒุงุด ุณุจุฏ ุฎุฑุฏ ูุดุชุฑโูุง ู ูุฑุฎ ุจุงุฒฺฏุดุช ุงููโูุง ุจู ุณุงุช ูุฑูุดฺฏุงู ููฺฉุงูุฑุณ ุชูุณุนู ุฏุงุฏู.
ุงูุฒููู ุชุง ุญุงูุง 2000 ูุตุจ ูุนุงู ุฏุฑ ฺุงฺฉุช ุฏุงุดุชูุ
ุงฺฏู ุชูุงู ุฏุงุฑุฏ ุจุดุชุฑ ุชูุถุญ ุจุฏู"""

# Initialize chat
if "chat_history" not in st.session_state:
    st.session_state.chat_history = [{"role": "agent", "message": starting_message}]

# Display all chat messages
for msg in st.session_state.chat_history:
    with st.chat_message("๐ค" if msg["role"] == "user" else "๐ค"):
        st.markdown(msg["message"])

# User inputs their message as buyer
user_message = st.chat_input("โ๏ธ ูพุงุณุฎ ุฎูุฏ ุฑุง ูุงุฑุฏ ฺฉูุฏ...")

user_messages = ""

if user_message:
    # Append user message
    st.session_state.chat_history.append({"role": "user", "message": user_message})
    
    user_messages += user_message
    # Generate agent response
    agent_response = get_gemini_api_response(system_prompt + "\n" + user_messages)
    st.session_state.chat_history.append({"role": "agent", "message": agent_response})

    st.rerun()

# Threshold slider
threshold = st.slider("๐ฏ ุขุณุชุงูู ุงูุชุงุฒุฏู", 1, 10, 8)

# Score button
if st.button("Lead Score"):
    full_chat = ""
    for msg in st.session_state.chat_history:
        full_chat += ("ูุดุชุฑ: " if msg["role"] == "user" else "ูุฑูุดูุฏู: ") + msg["message"] + "\n"

    if full_chat.strip():
        with st.spinner("ุฏุฑ ุญุงู ุชุญูู ฺุช..."):
            try:
                result = leadScoring(full_chat, threshold=threshold)
                st.success("โ ุชุญูู ฺฉุงูู ุดุฏ")

                st.subheader("๐ ูุชุงุฌ ุชุญูู")
                for key, value in result["criteria"].items():
                    st.markdown(f"**{key}**")
                    st.progress(value["score"] / 2)
                    st.markdown(f"_ุชูุถุญ_: {value['explanation']}")
                    st.markdown("---")

                st.markdown(f"**ุงูุชุงุฒ ฺฉู**: {result['total_score']}")
                st.markdown(f"**ุทุจููโุจูุฏ ูุฏ**: `{result['lead_class']}`")

            except Exception as e:
                st.error(f"โ ูุดฺฉู ุฑุฎ ุฏุงุฏ: {e}")
    else:
        st.warning("ูฺฉุงูููโุง ุจุฑุง ุชุญูู ูุฌูุฏ ูุฏุงุฑุฏ.")

# Reset chat
if st.button("๐ Reset"):
    st.session_state.chat_history = [{"role": "agent", "message": starting_message}]
    st.rerun()
